<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Consumption Management Panel (CRUD + Prediction)</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 40px;
            background-color: #f0f4f7;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #007bff;
            text-align: center;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        h2 {
            margin-top: 30px;
            color: #333;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #c7d9e8;
            border-radius: 5px;
            box-sizing: border-box;
        }
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 15px;
            width: 100%;
            font-size: 16px;
            color: white;
            transition: opacity 0.3s;
        }
        button:hover {
            opacity: 0.9;
        }
        #predictionForm button { background-color: #28a745; }
        #loadDataButton { background-color: #007bff; }
        #createForm button { background-color: #ffc107; color: #333; }
        #updateForm button { background-color: #17a2b8; }
        #deleteForm button { background-color: #dc3545; }

        .result-box {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }
        #result, #createResult, #updateResult, #deleteResult {
            border: 1px solid #007bff;
            background-color: #e6f7ff;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9em;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .form-row {
            display: flex;
            gap: 20px;
        }
        .form-row > div {
            flex: 1;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>‚öôÔ∏è Energy Consumption Management Panel</h1>

        <h2>üîÆ 1. Predict Consumption</h2>
        <form id="predictionForm">
            <div class="form-row">
                <div>
                    <label for="hour">Hour (0-23):</label>
                    <input type="number" id="hour" name="Hour" min="0" max="23" required value="17">
                </div>
                <div>
                    <label for="dayOfWeek">Day of Week (0=Mon, 6=Sun):</label>
                    <input type="number" id="dayOfWeek" name="DayOfWeek" min="0" max="6" required value="4">
                </div>
                <div>
                    <label for="dayOfMonth">Day of Month (1-31):</label>
                    <input type="number" id="dayOfMonth" name="DayOfMonth" min="1" max="31" required value="15">
                </div>
            </div>
            <button type="submit">Start Prediction</button>
        </form>
        <div id="result" class="result-box">
            Prediction result will be displayed here.
        </div>

        <h2>üìã 2. List Records</h2>
        <button id="loadDataButton" onclick="loadData()">Load/Refresh Data</button>
        <div id="dataListContainer" style="margin-top: 15px; max-height: 300px; overflow-y: auto;">
            <p>Click the button above to list data. (Only first 10 records are shown)</p>
        </div>
        
        <h2>‚ûï 3. Add New Record</h2>
        <form id="createForm">
            <div class="form-row">
                <div>
                    <label for="new_hour">Hour:</label>
                    <input type="number" id="new_hour" name="Hour" min="0" max="23" required value="10">
                </div>
                <div>
                    <label for="new_dayofweek">Day of Week:</label>
                    <input type="number" id="new_dayofweek" name="DayOfWeek" min="0" max="6" required value="2">
                </div>
                <div>
                    <label for="new_dayofmonth">Day of Month:</label>
                    <input type="number" id="new_dayofmonth" name="DayOfMonth" min="1" max="31" required value="5">
                </div>
                <div>
                    <label for="new_consumption">Consumption (kWh):</label>
                    <input type="number" step="0.001" id="new_consumption" name="Consumption" required value="5.500">
                </div>
            </div>
            <button type="submit">Add Record</button>
        </form>
        <div id="createResult" class="result-box"></div>

        <h2>üîÑ 4. Update Record</h2>
        <form id="updateForm">
            <div class="form-row">
                <div>
                    <label for="recordIdToUpdate">Record ID to Update:</label>
                    <input type="number" id="recordIdToUpdate" name="RecordID" required placeholder="Enter an ID from the list">
                </div>
                <div>
                    <label for="update_consumption">New Consumption (kWh):</label>
                    <input type="number" step="0.001" id="update_consumption" name="Consumption" required value="9.999">
                </div>
            </div>
            <button type="submit">Update Record</button>
        </form>
        <div id="updateResult" class="result-box"></div>

        <h2>üóëÔ∏è 5. Delete Record</h2>
        <form id="deleteForm">
            <label for="recordIdToDelete">Record ID to Delete:</label>
            <input type="number" id="recordIdToDelete" name="RecordID" required placeholder="Enter the ID you want to delete">
            <button type="submit">Delete Record</button>
        </form>
        <div id="deleteResult" class="result-box"></div>

    </div>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:8000';

        async function getErrorMessage(response) {
            try {
                const errorData = await response.json();
                if (errorData.detail && Array.isArray(errorData.detail)) {
                    return errorData.detail.map(d => {
                        const loc = d.loc.length > 1 ? d.loc.slice(-1) : d.loc[0];
                        if (d.msg.includes("value is not a valid integer")) return `${loc} is not a valid integer.`;
                        if (d.msg.includes("value is not a valid float")) return `${loc} is not a valid float value.`;
                        if (d.msg.includes("field required")) return `${loc} field is required.`;
                        if (d.msg.includes("must be less than or equal to")) return `${loc} has reached the maximum value.`;
                        if (d.msg.includes("Input should be a valid integer")) return `${loc} must be a valid integer.`;
                        return `${loc}: ${d.msg}`;
                    }).join(' | ');
                }
                if (errorData.detail) {
                    return errorData.detail;
                }
                return `Unknown API Error (HTTP ${response.status})`;
            } catch (e) {
                return `API response cannot be read (HTTP ${response.status})`;
            }
        }

        document.getElementById('predictionForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            const data = {
                Hour: parseInt(formData.get('Hour')),
                DayOfWeek: parseInt(formData.get('DayOfWeek')),
                DayOfMonth: parseInt(formData.get('DayOfMonth'))
            };

            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '‚è≥ Calculating Prediction...';
            resultDiv.style.borderColor = '#ffc107';

            try {
                const response = await fetch(`${API_BASE_URL}/predict_consumption`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorMessage = await getErrorMessage(response);
                    throw new Error(errorMessage);
                }

                const predictionData = await response.json();
                const predictedValue = predictionData.Predicted_Consumption;
                
                resultDiv.innerHTML = `
                    ‚úÖ Prediction Successful<br>
                    <strong>Estimated Energy Consumption: ${predictedValue.toFixed(4)} kWh</strong>
                `;
                resultDiv.style.borderColor = '#00b33c';

            } catch (error) {
                resultDiv.innerHTML = `
                    ‚ùå Prediction failed! <br> 
                    API error: ${error.message}.
                `;
                resultDiv.style.borderColor = '#dc3545';
            }
        });

        document.getElementById('loadDataButton').addEventListener('click', loadData);

        async function loadData() {
            const container = document.getElementById('dataListContainer');
            container.innerHTML = 'Loading data...';

            try {
                const response = await fetch(`${API_BASE_URL}/records`);
                if (!response.ok) {
                    throw new Error(`HTTP Error Code: ${response.status}`);
                }
                const data = await response.json();

                if (data.length === 0) {
                    container.innerHTML = 'No records found.';
                    return;
                }

                const displayData = data.slice(0, 10);
                let tableHtml = '<table border="1"><thead><tr>';
                
                const headers = Object.keys(displayData[0]);
                headers.forEach(h => {
                    tableHtml += `<th>${h}</th>`;
                });
                tableHtml += '</tr></thead><tbody>';

                displayData.forEach(record => {
                    tableHtml += '<tr>';
                    headers.forEach(h => {
                        if (h === 'RecordID') {
                            tableHtml += `<td style="font-weight: bold; color: #007bff;">${record[h]}</td>`;
                        } else {
                            if (h === 'Consumption' && typeof record[h] === 'number') {
                                tableHtml += `<td>${record[h].toFixed(3)}</td>`;
                            } else {
                                tableHtml += `<td>${record[h]}</td>`;
                            }
                        }
                    });
                    tableHtml += '</tr>';
                });

                tableHtml += '</tbody></table>';
                container.innerHTML = tableHtml;

            } catch (error) {
                container.innerHTML = `‚ùå Error loading data: ${error.message}`;
                console.error('Data Loading Error:', error);
            }
        }
        
        window.onload = loadData;

        document.getElementById('createForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            const data = {
                Hour: parseInt(formData.get('Hour')),
                DayOfWeek: parseInt(formData.get('DayOfWeek')),
                DayOfMonth: parseInt(formData.get('DayOfMonth')),
                Consumption: parseFloat(formData.get('Consumption'))
            };

            const resultDiv = document.getElementById('createResult');
            resultDiv.innerHTML = 'Adding record...';

            try {
                const response = await fetch(`${API_BASE_URL}/records`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorMessage = await getErrorMessage(response);
                    throw new Error(errorMessage);
                }

                const jsonResponse = await response.json();
                
                resultDiv.innerHTML = `‚úÖ Record Added Successfully. New ID: <strong style="color: #007bff;">${jsonResponse.RecordID}</strong>`;
                resultDiv.style.borderColor = '#00b33c';

                loadData();

            } catch (error) {
                resultDiv.innerHTML = `‚ùå Error: ${error.message}`;
                resultDiv.style.borderColor = '#dc3545';
            }
        });
        
        document.getElementById('updateForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const recordId = document.getElementById('recordIdToUpdate').value;
            const newConsumption = document.getElementById('update_consumption').value;

            const resultDiv = document.getElementById('updateResult');
            resultDiv.innerHTML = `Updating record ${recordId}...`;

            try {
                const response = await fetch(`${API_BASE_URL}/records/${recordId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        Consumption: parseFloat(newConsumption),
                        Hour: 0, 
                        DayOfWeek: 0, 
                        DayOfMonth: 1 
                    })
                });

                if (!response.ok) {
                    const errorMessage = await getErrorMessage(response);
                    throw new Error(errorMessage);
                }

                const jsonResponse = await response.json();

                resultDiv.innerHTML = `‚úÖ Record <strong style="color: #007bff;">${recordId}</strong> updated successfully. New Consumption: ${jsonResponse.Consumption.toFixed(3)}`;
                resultDiv.style.borderColor = '#00b33c';

                loadData();

            } catch (error) {
                resultDiv.innerHTML = `‚ùå Error: ${error.message}`;
                resultDiv.style.borderColor = '#dc3545';
            }
        });

        document.getElementById('deleteForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const recordId = document.getElementById('recordIdToDelete').value;
            
            const resultDiv = document.getElementById('deleteResult');
            resultDiv.innerHTML = `Deleting record ${recordId}...`;

            try {
                const response = await fetch(`${API_BASE_URL}/records/${recordId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const errorMessage = await getErrorMessage(response);
                    throw new Error(errorMessage);
                }
                
                resultDiv.innerHTML = `‚úÖ Record <strong style="color: #007bff;">${recordId}</strong> deleted successfully.`;
                resultDiv.style.borderColor = '#00b33c';

                loadData();

            } catch (error) {
                resultDiv.innerHTML = `‚ùå Error: ${error.message}`;
                resultDiv.style.borderColor = '#dc3545';
            }
        });
    </script>
</body>
</html>
